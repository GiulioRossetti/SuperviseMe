{% include 'admin/components/header.html' %}

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        {% include 'student/components/sidebar.html' %}
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Topbar -->
                {% include 'admin/components/topbar.html' %}
                <!-- End of Topbar -->

                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">My Thesis</h1>
                    </div>

                    <!-- Thesis Info Row -->
                    <div class="row">
                        <div class="col-xl-8 col-lg-7">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">{{ thesis.title }}</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-gray-700">{{ thesis.description }}</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Level:</strong> {{ thesis.level|title if thesis.level else 'Not specified' }}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Created:</strong> {{ dt(thesis.created_at).strftime('%B %d, %Y') if thesis.created_at else 'Unknown' }}
                                        </div>
                                    </div>
                                    {% if supervisors %}
                                    <div class="mt-3">
                                        <strong>Supervisors:</strong>
                                        {% for supervisor in supervisors %}
                                            <span class="badge badge-info mr-1">{{ supervisor.name }} {{ supervisor.surname }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Statistics Section -->
                        <div class="col-xl-4 col-lg-5">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center mb-3">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Total Updates</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ updates|length }}</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-edit fa-2x text-gray-300"></i>
                                        </div>
                                    </div>

                                    <div class="row no-gutters align-items-center mb-3">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                Student Updates</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                {{ updates|selectattr('update_type', 'equalto', 'student_update')|list|length }}
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-user fa-2x text-gray-300"></i>
                                        </div>
                                    </div>

                                    <div class="row no-gutters align-items-center mb-3">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                Objectives</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ objectives|length }}</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-bullseye fa-2x text-gray-300"></i>
                                        </div>
                                    </div>

                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                Resources</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ resources|length }}</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-folder fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Thesis Status Section -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary" id="status">Thesis Status</h6>
                                </div>
                                <div class="card-body">
                                    {% if thesis_statuses %}
                                        <div class="timeline">
                                            {% for status in thesis_statuses %}
                                            <div class="timeline-item mb-3 p-3 bg-light border-left-primary">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="status-info">
                                                        <h6 class="mb-1 text-primary">{{ status.status|title }}</h6>
                                                        <small class="text-muted">
                                                            {{ dt(status.updated_at).strftime('%B %d, %Y at %I:%M %p') if status.updated_at else 'Unknown time' }}
                                                        </small>
                                                    </div>
                                                    <span class="badge badge-primary">{{ status.status }}</span>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-info-circle fa-2x text-gray-300 mb-3"></i>
                                            <p class="text-muted">No status updates yet.</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Objectives Section -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary" id="objectives">Objectives</h6>
                                    <button class="btn btn-success btn-sm" data-toggle="modal" data-target="#addObjectiveModal">
                                        <i class="fas fa-plus"></i> Add Objective
                                    </button>
                                </div>
                                <div class="card-body">
                                    {% if objectives %}
                                        {% for objective in objectives %}
                                        <div class="card mb-3 {% if objective.frozen %}border-warning{% endif %}">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="font-weight-bold">{{ objective.title }}</h6>
                                                    <div class="d-flex align-items-center">
                                                        {% if objective.frozen %}
                                                            <span class="badge badge-warning mr-2">Frozen</span>
                                                        {% endif %}
                                                        {% if not objective.frozen %}
                                                        <a href="{{ url_for('student.delete_objective', objective_id=objective.id) }}" 
                                                           class="btn btn-sm btn-outline-danger"
                                                           onclick="return confirm('Are you sure you want to delete this objective?')">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <p class="text-gray-700">{{ objective.description }}</p>
                                                <small class="text-muted">
                                                    Created: {{ dt(objective.created_at).strftime('%B %d, %Y at %I:%M %p') if objective.created_at else 'Unknown' }}
                                                </small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-gray-500 text-center">No objectives defined yet. Add your first objective to outline your thesis goals!</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hypotheses Section -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary" id="hypotheses">Hypotheses</h6>
                                    <button class="btn btn-success btn-sm" data-toggle="modal" data-target="#addHypothesisModal">
                                        <i class="fas fa-plus"></i> Add Hypothesis
                                    </button>
                                </div>
                                <div class="card-body">
                                    {% if hypotheses %}
                                        {% for hypothesis in hypotheses %}
                                        <div class="card mb-3 {% if hypothesis.frozen %}border-warning{% endif %}">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="font-weight-bold">{{ hypothesis.title }}</h6>
                                                    <div class="d-flex align-items-center">
                                                        {% if hypothesis.frozen %}
                                                            <span class="badge badge-warning mr-2">Frozen</span>
                                                        {% endif %}
                                                        {% if not hypothesis.frozen %}
                                                        <a href="{{ url_for('student.delete_hypothesis', hypothesis_id=hypothesis.id) }}" 
                                                           class="btn btn-sm btn-outline-danger"
                                                           onclick="return confirm('Are you sure you want to delete this hypothesis?')">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <p class="text-gray-700">{{ hypothesis.description }}</p>
                                                <small class="text-muted">
                                                    Created: {{ dt(hypothesis.created_at).strftime('%B %d, %Y at %I:%M %p') if hypothesis.created_at else 'Unknown' }}
                                                </small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-gray-500 text-center">No hypotheses defined yet. Add your first hypothesis to outline your research assumptions!</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Updates & Feedbacks Section -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary" id="updates">Updates & Progress</h6>
                                    <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addUpdateModal">
                                        <i class="fas fa-plus"></i> Add Update
                                    </button>
                                </div>
                                <div class="card-body">
                                    {% if parent_updates %}
                                        {% for update in parent_updates %}
                                        <div class="update-thread mb-4">
                                            <!-- Main Update -->
                                            <div class="update-item p-3 {% if update.update_type == 'supervisor_update' %}bg-light{% else %}bg-white{% endif %} border rounded">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="update-info">
                                                        <div class="d-flex align-items-center mb-2">
                                                            {% if update.update_type == 'student_update' %}
                                                                <i class="fas fa-user text-primary mr-2"></i>
                                                                <strong class="text-primary">You</strong>
                                                            {% elif update.update_type == 'supervisor_update' %}
                                                                <i class="fas fa-user-tie text-info mr-2"></i>
                                                                <strong class="text-info">Supervisor</strong>
                                                            {% endif %}
                                                            <small class="text-gray-500 ml-2">
                                                                {{ dt(update.created_at).strftime('%B %d, %Y at %I:%M %p') if update.created_at else 'Unknown time' }}
                                                            </small>
                                                        </div>
                                                        <div class="update-content">
                                                            {% set formatted_content = update.content|replace('\n', '<br>') %}
                                                            {{ formatted_content|format_todo_links('student')|safe }}
                                                        </div>
                                                        
                                                        <!-- Todo References -->
                                                        {% if update.todo_references %}
                                                        <div class="mt-2">
                                                            <small class="text-muted">Referenced Todos:</small>
                                                            {% for ref in update.todo_references %}
                                                            <a href="{{ url_for('student.todo_detail', todo_id=ref.todo.id) }}" 
                                                               class="badge badge-primary ml-1" title="{{ ref.todo.title }}">
                                                                <i class="fas fa-tasks"></i> {{ ref.todo.title[:20] }}{% if ref.todo.title|length > 20 %}...{% endif %}
                                                            </a>
                                                            {% endfor %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    {% if update.update_type == 'student_update' and update.author_id == current_user.id %}
                                                    <div class="update-actions">
                                                        <div class="dropdown">
                                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown">
                                                                <i class="fas fa-ellipsis-v"></i>
                                                            </button>
                                                            <div class="dropdown-menu">
                                                                <a class="dropdown-item" href="#" onclick="editUpdate({{ update.id }}, '{{ update.content|e }}')">
                                                                    <i class="fas fa-edit"></i> Edit
                                                                </a>
                                                                <a class="dropdown-item text-danger" href="{{ url_for('student.delete_update', update_id=update.id) }}" 
                                                                   onclick="return confirm('Are you sure you want to delete this update?')">
                                                                    <i class="fas fa-trash"></i> Delete
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <!-- Nested Comments/Feedback -->
                                            {% if update.id in comments_by_parent %}
                                                <div class="feedback-replies ml-4 mt-2">
                                                    {% for comment in comments_by_parent[update.id] %}
                                                    <div class="comment-item p-3 mb-2 bg-light border-left border-info rounded">
                                                        <div class="d-flex align-items-center mb-2">
                                                            {% if comment.update_type == 'supervisor_comment' or comment.update_type == 'supervisor_update' %}
                                                                <i class="fas fa-user-tie text-info mr-2"></i>
                                                                <strong class="text-info">Supervisor Feedback</strong>
                                                            {% else %}
                                                                <i class="fas fa-user text-primary mr-2"></i>
                                                                <strong class="text-primary">Student Reply</strong>
                                                            {% endif %}
                                                            <small class="text-gray-500 ml-2">
                                                                {{ dt(comment.created_at).strftime('%B %d, %Y at %I:%M %p') if comment.created_at else 'Unknown time' }}
                                                            </small>
                                                        </div>
                                                        <div class="comment-content">
                                                            {{ comment.content|replace('\n', '<br>')|safe }}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Show Todo References if any -->
                                            {% if todos %}
                                                {% set update_content = update.content|lower %}
                                                {% set todo_refs = [] %}
                                                {% for todo in todos %}
                                                    {% if ('todo #' + todo.id|string) in update_content or todo.title.lower() in update_content %}
                                                        {% set _ = todo_refs.append(todo) %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% if todo_refs %}
                                                <div class="todo-references ml-4 mt-2 p-2 bg-warning-light rounded">
                                                    <small class="text-muted"><i class="fas fa-link"></i> Referenced ToDos:</small>
                                                    <div class="mt-1">
                                                        {% for todo in todo_refs %}
                                                        <a href="#todos" class="badge badge-warning mr-1" title="{{ todo.description }}">
                                                            <i class="fas fa-tasks"></i> {{ todo.title }}
                                                        </a>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-edit fa-2x text-gray-300 mb-3"></i>
                                            <p class="text-muted">No updates yet. <a href="#" data-toggle="modal" data-target="#addUpdateModal">Add your first update!</a></p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Meeting Notes Section -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Meeting Notes</h6>
                                    <button class="btn btn-success btn-sm" data-toggle="modal" data-target="#addMeetingNoteModal">
                                        <i class="fas fa-plus"></i> Add Meeting Note
                                    </button>
                                </div>
                                <div class="card-body">
                                    {% if meeting_notes %}
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="meetingNotesTable">
                                            <thead>
                                                <tr>
                                                    <th width="25%">Title</th>
                                                    <th width="35%">Content</th>
                                                    <th width="15%">Author</th>
                                                    <th width="10%">Created</th>
                                                    <th width="10%">Updated</th>
                                                    <th width="5%">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for note in meeting_notes %}
                                                <tr>
                                                    <td>
                                                        <strong>
                                                            <a href="{{ url_for('student.meeting_note_detail', note_id=note.id) }}" 
                                                               class="text-decoration-none">
                                                                {{ note.title }}
                                                            </a>
                                                        </strong>
                                                    </td>
                                                    <td>
                                                        <div class="meeting-note-content">
                                                            {{ note.content|markdown_with_todos('student')|safe }}
                                                        </div>
                                                        <!-- Todo References -->
                                                        {% if note.todo_references %}
                                                        <div class="mt-2">
                                                            <small class="text-muted">Referenced Todos:</small>
                                                            {% for ref in note.todo_references %}
                                                            <a href="{{ url_for('student.todo_detail', todo_id=ref.todo.id) }}" 
                                                               class="badge badge-primary ml-1" title="{{ ref.todo.title }}">
                                                                <i class="fas fa-tasks"></i> {{ ref.todo.title[:15] }}{% if ref.todo.title|length > 15 %}...{% endif %}
                                                            </a>
                                                            {% endfor %}
                                                        </div>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">
                                                            {% if note.author %}
                                                                {{ note.author.name }} {{ note.author.surname }}
                                                                {% if note.author.user_type == 'supervisor' %}
                                                                    <i class="fas fa-chalkboard-teacher text-primary" title="Supervisor"></i>
                                                                {% else %}
                                                                    <i class="fas fa-user-graduate text-success" title="Student"></i>
                                                                {% endif %}
                                                            {% else %}
                                                                Unknown
                                                            {% endif %}
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">{{ dt(note.created_at).strftime('%m/%d/%Y') if note.created_at else 'Unknown' }}</small>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">
                                                            {% if note.updated_at != note.created_at %}
                                                                {{ dt(note.updated_at).strftime('%m/%d/%Y') if note.updated_at else 'Unknown' }}
                                                            {% else %}
                                                                -
                                                            {% endif %}
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group" role="group">
                                                            <a href="{{ url_for('student.meeting_note_detail', note_id=note.id) }}" 
                                                               class="btn btn-outline-info btn-sm" title="View Details">
                                                                <i class="fas fa-eye"></i>
                                                            </a>
                                                            {% if note.author_id == thesis.author_id %}
                                                            <button class="btn btn-outline-primary btn-sm" 
                                                                    onclick="editMeetingNote({{ note.id }}, '{{ note.title }}', '{{ note.content|replace('\n', '\\n')|replace('\'', '\\\'') }}')"
                                                                    title="Edit">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <form method="POST" action="{{ url_for('student.delete_meeting_note', note_id=note.id) }}" 
                                                                  style="display: inline;"
                                                                  onsubmit="return confirm('Are you sure you want to delete this meeting note?');">
                                                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-4">
                                        <i class="fas fa-sticky-note fa-2x text-gray-300 mb-3"></i>
                                        <p class="text-muted">No meeting notes yet. <a href="#" data-toggle="modal" data-target="#addMeetingNoteModal">Add your first meeting note!</a></p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ToDo Section -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary" id="todos">ToDo List</h6>
                                    <button class="btn btn-success btn-sm" data-toggle="modal" data-target="#addTodoModal">
                                        <i class="fas fa-plus"></i> Add ToDo
                                    </button>
                                </div>
                                <div class="card-body">
                                    {% if todos %}
                                        <div class="table-responsive">
                                            <table class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th width="5%">Status</th>
                                                        <th width="30%">Task</th>
                                                        <th width="25%">Description</th>
                                                        <th width="10%">Priority</th>
                                                        <th width="15%">Due Date</th>
                                                        <th width="15%">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for todo in todos %}
                                                    <tr class="{% if todo.status == 'completed' %}table-success{% elif todo.status == 'cancelled' %}table-danger{% endif %}">
                                                        <td class="text-center">
                                                            {% if todo.status == 'completed' %}
                                                                <i class="fas fa-check-circle text-success" title="Completed"></i>
                                                            {% elif todo.status == 'cancelled' %}
                                                                <i class="fas fa-times-circle text-danger" title="Cancelled"></i>
                                                            {% else %}
                                                                <i class="fas fa-clock text-warning" title="Pending"></i>
                                                            {% endif %}
                                                        </td>
                                                        <td><strong>{{ todo.title }}</strong></td>
                                                        <td>{{ todo.description or 'No description' }}</td>
                                                        <td>
                                                            <span class="badge badge-{% if todo.priority == 'high' %}danger{% elif todo.priority == 'medium' %}warning{% else %}secondary{% endif %}">
                                                                {{ todo.priority|title }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            {% if todo.due_date %}
                                                                {{ dt(todo.due_date).strftime('%Y-%m-%d') }}
                                                            {% else %}
                                                                <span class="text-muted">No due date</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if todo.status != 'completed' %}
                                                                <a href="{{ url_for('student.toggle_todo', todo_id=todo.id) }}" 
                                                                   class="btn btn-success btn-sm" title="Mark as completed">
                                                                    <i class="fas fa-check"></i>
                                                                </a>
                                                            {% else %}
                                                                <a href="{{ url_for('student.toggle_todo', todo_id=todo.id) }}" 
                                                                   class="btn btn-secondary btn-sm" title="Mark as pending">
                                                                    <i class="fas fa-undo"></i>
                                                                </a>
                                                            {% endif %}
                                                            <a href="{{ url_for('student.delete_todo', todo_id=todo.id) }}" 
                                                               class="btn btn-danger btn-sm" title="Delete"
                                                               onclick="return confirm('Are you sure you want to delete this todo?')">
                                                                <i class="fas fa-trash"></i>
                                                            </a>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-tasks fa-2x text-gray-300 mb-3"></i>
                                            <p class="text-muted">No todos yet. <a href="#" data-toggle="modal" data-target="#addTodoModal">Add your first todo!</a></p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resources Section -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary" id="resources">Resources</h6>
                                    <button class="btn btn-success btn-sm" data-toggle="modal" data-target="#addResourceModal">
                                        <i class="fas fa-plus"></i> Add Resource
                                    </button>
                                </div>
                                <div class="card-body">
                                    {% if resources %}
                                        <div class="table-responsive">
                                            <table class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>Type</th>
                                                        <th>Link/URL</th>
                                                        <th>Description</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for resource in resources %}
                                                    <tr>
                                                        <td><span class="badge badge-secondary">{{ resource.resource_type|title }}</span></td>
                                                        <td><a href="{{ resource.resource_url }}" target="_blank" class="text-primary">{{ resource.resource_url }}</a></td>
                                                        <td>{{ resource.description or 'No description' }}</td>
                                                        <td>
                                                            <a href="{{ url_for('student.delete_resource', resource_id=resource.id) }}" 
                                                               class="btn btn-sm btn-outline-danger"
                                                               onclick="return confirm('Are you sure you want to delete this resource?')">
                                                                <i class="fas fa-trash"></i>
                                                            </a>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p class="text-gray-500 text-center">No resources added yet.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            {% include 'admin/components/footer.html' %}
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Add Update Modal -->
    <div class="modal fade" id="addUpdateModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Update</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('student.post_update') }}">
                    <div class="modal-body">
                        <input type="hidden" name="thesis_id" value="{{ thesis.id }}">
                        <div class="form-group">
                            <label for="content">Update Content:</label>
                            <textarea class="form-control" name="content" rows="5" required placeholder="Describe your progress, challenges, or achievements..."></textarea>
                            <small class="form-text text-muted">
                                <strong>Todo References:</strong> Use @todo:ID or #todo-ID to reference todos. 
                                {% if todos %}Available todos: 
                                {% for todo in todos[:3] %}@todo:{{ todo.id }} ({{ todo.title[:20] }}{% if todo.title|length > 20 %}...{% endif %}){% if not loop.last %}, {% endif %}{% endfor %}
                                {% if todos|length > 3 %}... and {{ todos|length - 3 }} more{% endif %}
                                {% endif %}
                            </small>
                        </div>
                        {% if todos %}
                        <div class="form-group">
                            <label>Quick Todo Reference:</label>
                            <div class="btn-group-toggle" data-toggle="buttons">
                                {% for todo in todos %}
                                <label class="btn btn-outline-secondary btn-sm mr-1 mb-1" onclick="insertTodoReference({{ todo.id }}, '{{ todo.title }}')">
                                    <input type="checkbox"> @todo:{{ todo.id }}
                                    <br><small>{{ todo.title[:30] }}{% if todo.title|length > 30 %}...{% endif %}</small>
                                </label>
                                {% endfor %}
                            </div>
                            <small class="form-text text-muted">Click buttons above to insert todo references into your update.</small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Resource Modal -->
    <div class="modal fade" id="addResourceModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Resource</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('student.add_resource') }}">
                    <div class="modal-body">
                        <input type="hidden" name="thesis_id" value="{{ thesis.id }}">
                        <div class="form-group">
                            <label for="resource_type">Resource Type:</label>
                            <select class="form-control" name="resource_type" required>
                                <option value="document">Document</option>
                                <option value="link">Web Link</option>
                                <option value="paper">Research Paper</option>
                                <option value="book">Book</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resource_link">URL/Link:</label>
                            <input type="url" class="form-control" name="resource_link" required placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="description">Description (optional):</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="Brief description of the resource..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Add Resource</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Update Modal -->
    <div class="modal fade" id="editUpdateModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Update</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('student.modify_update') }}">
                    <div class="modal-body">
                        <input type="hidden" name="update_id" id="edit_update_id">
                        <div class="form-group">
                            <label for="new_content">Update Content:</label>
                            <textarea class="form-control" name="new_content" id="edit_update_content" rows="5" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Objective Modal -->
    <div class="modal fade" id="addObjectiveModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Objective</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('student.add_objective') }}">
                    <div class="modal-body">
                        <input type="hidden" name="thesis_id" value="{{ thesis.id }}">
                        <div class="form-group">
                            <label for="title">Objective Title:</label>
                            <input type="text" class="form-control" name="title" required placeholder="Brief title for your objective">
                        </div>
                        <div class="form-group">
                            <label for="description">Objective Description:</label>
                            <textarea class="form-control" name="description" rows="4" required placeholder="Describe what you aim to achieve with this objective..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Objective</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Hypothesis Modal -->
    <div class="modal fade" id="addHypothesisModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Hypothesis</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('student.add_hypothesis') }}">
                    <div class="modal-body">
                        <input type="hidden" name="thesis_id" value="{{ thesis.id }}">
                        <div class="form-group">
                            <label for="title">Hypothesis Title:</label>
                            <input type="text" class="form-control" name="title" required placeholder="Brief title for your hypothesis">
                        </div>
                        <div class="form-group">
                            <label for="description">Hypothesis Description:</label>
                            <textarea class="form-control" name="description" rows="4" required placeholder="Describe your research hypothesis or assumption..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Hypothesis</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Todo Modal -->
    <div class="modal fade" id="addTodoModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New ToDo</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('student.add_todo') }}">
                    <div class="modal-body">
                        <input type="hidden" name="thesis_id" value="{{ thesis.id }}">
                        <div class="form-group">
                            <label for="title">Task Title:</label>
                            <input type="text" class="form-control" name="title" required placeholder="Brief description of the task">
                        </div>
                        <div class="form-group">
                            <label for="description">Task Description:</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="Detailed description of what needs to be done..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="priority">Priority:</label>
                                    <select class="form-control" name="priority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="due_date">Due Date (optional):</label>
                                    <input type="date" class="form-control" name="due_date">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add ToDo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    {% include 'admin/components/logout_modal.html' %}


    <script>        
        function editUpdate(updateId, content) {
            $('#edit_update_id').val(updateId);
            $('#edit_update_content').val(content);
            $('#editUpdateModal').modal('show');
        }

        function insertTodoReference(todoId, todoTitle) {
            const textarea = document.querySelector('textarea[name="content"]');
            const reference = `@todo:${todoId}`;
            const currentPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, currentPos);
            const textAfter = textarea.value.substring(textarea.selectionEnd);
            
            // Add space before if needed
            const spaceBefore = (textBefore.length > 0 && !textBefore.endsWith(' ') && !textBefore.endsWith('\n')) ? ' ' : '';
            const spaceAfter = ' ';
            
            textarea.value = textBefore + spaceBefore + reference + spaceAfter + textAfter;
            textarea.focus();
            
            // Set cursor after the reference
            const newPos = currentPos + spaceBefore.length + reference.length + spaceAfter.length;
            textarea.setSelectionRange(newPos, newPos);
        }
    </script>

    <!-- Meeting Notes Modals -->
    <!-- Add Meeting Note Modal -->
    <div class="modal fade" id="addMeetingNoteModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Meeting Note</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('student.add_meeting_note') }}">
                    <div class="modal-body">
                        <input type="hidden" name="thesis_id" value="{{ thesis.id }}">
                        <div class="form-group">
                            <label for="meetingNoteTitle">Meeting Title:</label>
                            <input type="text" class="form-control" name="title" id="meetingNoteTitle" required 
                                   placeholder="e.g., Weekly Meeting - Progress Review">
                        </div>
                        <div class="form-group">
                            <label for="meetingNoteContent">Meeting Notes:</label>
                            <textarea class="form-control" name="content" id="meetingNoteContent" rows="8" required 
                                      placeholder="Write your meeting notes using markdown. You can reference todos using @todo:ID syntax."></textarea>
                            <small class="form-text text-muted">
                                <strong>Markdown supported:</strong> **bold**, *italic*, `code`, [link](url), etc. <br>
                                <strong>Todo References:</strong> Use @todo:ID to reference todos. 
                                {% if todos %}Available todos: 
                                {% for todo in todos[:3] %}@todo:{{ todo.id }} ({{ todo.title[:20] }}{% if todo.title|length > 20 %}...{% endif %}){% if not loop.last %}, {% endif %}{% endfor %}
                                {% if todos|length > 3 %}... and {{ todos|length - 3 }} more{% endif %}
                                {% endif %}
                            </small>
                        </div>
                        {% if todos %}
                        <div class="form-group">
                            <label>Quick Todo Reference:</label>
                            <div class="btn-group-toggle" data-toggle="buttons">
                                {% for todo in todos %}
                                <label class="btn btn-outline-secondary btn-sm mr-1 mb-1" onclick="insertTodoReference({{ todo.id }}, '{{ todo.title }}', 'meetingNoteContent')">
                                    <input type="checkbox"> @todo:{{ todo.id }}
                                    <br><small>{{ todo.title[:30] }}{% if todo.title|length > 30 %}...{% endif %}</small>
                                </label>
                                {% endfor %}
                            </div>
                            <small class="form-text text-muted">Click buttons above to insert todo references into your meeting notes.</small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Meeting Note</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Meeting Note Modal -->
    <div class="modal fade" id="editMeetingNoteModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Meeting Note</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" id="editMeetingNoteForm">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="editMeetingNoteTitle">Meeting Title:</label>
                            <input type="text" class="form-control" name="title" id="editMeetingNoteTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="editMeetingNoteContent">Meeting Notes:</label>
                            <textarea class="form-control" name="content" id="editMeetingNoteContent" rows="8" required></textarea>
                            <small class="form-text text-muted">
                                <strong>Markdown supported:</strong> **bold**, *italic*, `code`, [link](url), etc. <br>
                                <strong>Todo References:</strong> Use @todo:ID to reference todos.
                            </small>
                        </div>
                        {% if todos %}
                        <div class="form-group">
                            <label>Quick Todo Reference:</label>
                            <div class="btn-group-toggle" data-toggle="buttons">
                                {% for todo in todos %}
                                <label class="btn btn-outline-secondary btn-sm mr-1 mb-1" onclick="insertTodoReference({{ todo.id }}, '{{ todo.title }}', 'editMeetingNoteContent')">
                                    <input type="checkbox"> @todo:{{ todo.id }}
                                    <br><small>{{ todo.title[:30] }}{% if todo.title|length > 30 %}...{% endif %}</small>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Meeting Note</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize DataTable for meeting notes with sorting and filtering
        $(document).ready(function() {
            $('#meetingNotesTable').DataTable({
                "order": [[ 3, "desc" ]], // Sort by created date descending
                "pageLength": 10,
                "responsive": true,
                "language": {
                    "emptyTable": "No meeting notes found"
                }
            });
        });

        function editMeetingNote(noteId, title, content) {
            $('#editMeetingNoteTitle').val(title);
            $('#editMeetingNoteContent').val(content);
            $('#editMeetingNoteForm').attr('action', '/student/edit_meeting_note/' + noteId);
            $('#editMeetingNoteModal').modal('show');
        }
        
        function insertTodoReference(todoId, todoTitle, targetTextareaId) {
            const textarea = document.getElementById(targetTextareaId);
            const reference = `@todo:${todoId}`;
            
            // Get current cursor position
            const currentPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, currentPos);
            const textAfter = textarea.value.substring(textarea.selectionEnd);
            
            // Add space before if needed
            const spaceBefore = (textBefore.length > 0 && !textBefore.endsWith(' ') && !textBefore.endsWith('\n')) ? ' ' : '';
            const spaceAfter = ' ';
            
            textarea.value = textBefore + spaceBefore + reference + spaceAfter + textAfter;
            textarea.focus();
            
            // Set cursor after the reference
            const newPos = currentPos + spaceBefore.length + reference.length + spaceAfter.length;
            textarea.setSelectionRange(newPos, newPos);
        }
    </script>

</body>

</html>