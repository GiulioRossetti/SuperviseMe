# Docker Deployment Guide

This guide describes how to run SuperviseMe using Docker with a complete production-ready setup including reverse proxy, database persistence, and mail server.

## Architecture

The Docker setup includes the following services:

- **superviseme_app**: Flask application running with Gunicorn
- **postgres**: PostgreSQL database with persistent storage
- **nginx**: Reverse proxy with SSL termination and static file serving
- **mailhog**: Development mail server for testing email functionality (use a real SMTP server for production)

## Quick Start

1. **Clone and navigate to the repository**:
   ```bash
   git clone https://github.com/GiulioRossetti/SuperviseMe.git
   cd SuperviseMe
   ```

2. **Create environment configuration**:
   ```bash
   cp .env.example .env
   ```
   Edit `.env` and customize the values, especially:
   - `SECRET_KEY`: Use a strong, unique secret key.
   - `ADMIN_BOOTSTRAP_PASSWORD`: Set a strong admin bootstrap password.
   - `PG_PASSWORD`: Set a secure database password.
   - `SKIP_DB_SEED`: Keep `true` in production (seed explicitly only when needed).
   - `ENABLE_SCHEDULER`: Keep `false` for web replicas; enable only in one scheduler worker.

3. **Provide TLS files for Nginx**:
   - Place certificate and key files in `nginx/ssl/`:
     - `superviseme.crt`
     - `superviseme.key`

4. **Start the application**:
   ```bash
   docker-compose up -d
   ```

5. **Access the application**:
   - Main application: `https://localhost` (accept the self-signed certificate if running locally)
   - Mail server UI: `http://localhost:8025`

## Services Details

### Web Application (superviseme_app)
- **Port**: Internal 8080 (proxied through Nginx)
- **Technology**: Flask + Gunicorn WSGI server
- **Database**: PostgreSQL with automatic schema initialization
- **Health Check**: HTTP health endpoint
- **Volumes**: Application data persistence

### Database (postgres)
- **Port**: Internal 5432
- **Technology**: PostgreSQL 15 Alpine
- **Persistence**: Named volume `postgres_data`
- **Initialization**: Automatic database and schema creation
- **Health Check**: PostgreSQL ready check

### Reverse Proxy (nginx)
- **Ports**: 80 (HTTP â†’ HTTPS redirect), 443 (HTTPS)
- **Features**:
  - SSL termination
  - Static file serving and caching
  - Rate limiting for security
  - Security headers
  - Gzip compression
- **Health Check**: HTTP health endpoint

### Mail Server (mailhog)
- **Ports**: 8025 (Web UI), 1025 (SMTP)
- **Purpose**: Development mail server for testing notifications.
- **Production**: For production, configure an external SMTP server in `.env`.

## Configuration

### Environment Variables

Key environment variables (see `.env.example`):

```bash
# Flask Configuration
FLASK_ENV=production
SECRET_KEY=your-secret-key
DEBUG=false
ENABLE_SCHEDULER=false
SKIP_DB_SEED=true

# Database Configuration
PG_USER=superviseme_user
PG_PASSWORD=your-secure-password
PG_DBNAME=superviseme

# Mail Configuration
MAIL_DEFAULT_SENDER=noreply@superviseme.local
MAIL_SERVER=mailhog
MAIL_PORT=1025
```

### SSL Certificates

SSL certificates are **not** auto-generated by the containers. Provide your own certificate and private key in `nginx/ssl/`.

For local development, you can generate self-signed certificates manually:
```bash
cd nginx/ssl
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout superviseme.key -out superviseme.crt \
  -subj "/C=US/ST=Dev/L=Local/O=SuperviseMe/CN=localhost"
```

For production, use a valid certificate from a CA (e.g., Let's Encrypt).

## Development Mode

For development with hot reloading:

```bash
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
```

Development features:
- Flask development server with auto-reload
- Source code volume mounting
- Debug mode enabled
- Direct access to application on port 8080

## Data Persistence

### Database Data
- **Volume**: `postgres_data`
- **Location**: PostgreSQL data directory
- **Backup**: Use `pg_dump` through the container:
  ```bash
  docker-compose exec postgres pg_dump -U superviseme_user superviseme > backup.sql
  ```

### Application Data
- **Volume**: `app_data`
- **Location**: Application database files and uploads
- **Purpose**: Persistent storage for SQLite fallback and file uploads

## Monitoring and Health Checks

All services include health checks:

```bash
# Check service status
docker-compose ps

# View logs
docker-compose logs -f superviseme_app
docker-compose logs -f postgres
docker-compose logs -f nginx

# Check health status
docker-compose exec superviseme_app curl -f http://localhost:8080/
```

## Security Considerations

### Development
- Self-signed SSL certificates (browser will show warnings)
- Never commit private keys or default credentials
- MailHog is for development only

### Production
- Replace self-signed certificates with valid SSL certificates
- Change all default passwords and secret keys
- Use a production mail server (SMTP)
- Keep `SKIP_DB_SEED=true` (avoid seeding on startup)
- Run scheduler in one process only (`ENABLE_SCHEDULER=true` in one service)
- Configure firewall rules
- Enable log monitoring and alerting
- Regular security updates
